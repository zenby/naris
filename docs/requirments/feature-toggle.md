# Feature toggle
## Мотивация
Иметь возможность гибко включать/выключать необходимые фичи.

## Архитектура
Информация о наборе фич для конкретных конфигураций хранится в дистрибутиве клиентского приложения (Naris) в файле `apps/naris/src/environments/feature-flags.ts` и представляет собой несколько конфигурационных объектов, по одному для каждой из возможных конфигураций.
Также в директории `apps/naris/src/environments` содержится несколько файлов окружения `enviroments.*.ts`, по одному для каждой конфигурации, каждый из которых использует соответствующий конфигурационный объект из файла `feature-flags.ts`.
При сборке приложения возможно указать конкретную конфигурацию во флаге `--configuration`.

## Конфигурации фич
- **Prod**. Фичи, которые включены на бою. Доступны всем пользователям.
- **ABTest**. Фичи, которые включены на бою и участвуют в А/Б тестировании. Доступны пользователям, попавшим в тестовую группу. Наследуется от Prod.
- **Dev**. Фичи, которые включены в dev-режиме. Доступны всем разработчикам. Наследуется от Prod.
- **DevABTest**. Фичи, которые включены в dev-режиме и участвуют в А/Б тестировании. Доступны всем разработчикам. Наследуется от ABTest.
- **Personal**. Фичи, которые включены в dev-режиме локально. Доступны разработчику локально, не попадают в общий репо. Набор полезен для проведения исследований с непредсказуемым результатом. Наследуется от Dev.

## Реализация
### Конфигурационные объекты

Список доступных фич хранится в интерфейсе DynamicConfig, который представляет собой список опциональных булиновых полей.
Интерфейс DynamicConfig описан в файле `apps/naris/src/environments/feature-flags.ts`.
Конфигурационный объект имплементирует этот интерфейс. В случае отсутствия указанного значения оно считается равным false (фича не используется в данном окружении).
Объекты могут наследоваться друг от друга путем копирования значений полей (см. конфигурации фич).
Например:

```
interface DynamicConfig {
  super_button?:boolean;
  auth_service_2?:boolean;
}

export const prod:DynamicConfig = {
  super_button:true
}

export const dev:DynamicConfig = {
  ...prod,
  auth_service_2.1.0: true
}
```

Этот конфиг используется в enviroments файлах следующим образом:

```
// enviroments.prod.ts

export const environment: EnvironmentInterface = {
  ...
  features: prod,
};

```

### Определение нужного конфига на этапе сборки

Приложение использует соответствующий конфигурационный файл при помощи механизма fileReplacements (см. https://angular.io/guide/build).
В project.json указывается, какой конкретно файл окружения соответствует каждой конфигурации.

### Сервис для работы с фичефлагами
За поставку информации о фичефлагах  отвечает сервис DynamicConfigService (динамический конфиг приложения). 
Хранится в папке `/naris/src/app/services/dynamic-config`.
При создании, в конструкторе инициализирует собственное состояние из объекта `environment.features`. 
Имеет один публичный метод:
* `hasFeature(flag:keyof DynamicConfig):boolean` - возвращает значение конкретного флага.

### Директива
Для условного рендеринга компонентов используется кастомная директива `*feature`, которая принимает строку или массив строк и разрешает рендер, если переданные флаги в DynamicConfigService равны true.
Пример использования в разметке:

```
<super-button *feature="super_button"></super-button>
```

### Роут гард

За доступ к урлам, которые доступны только при наличии определенной фичи, отвечает DynamicConfigGuard.
Он имплементирует интерфейс CanActivate, принимает список флагов (`string | string[]`) через данные роута и возвращает true из метода canActivate, если DynamicConfigService возвращает true для переданных флагов.
Пример использования в конфиге роутов:

```
const routes: Routes = [
  ...
  {
    path: '...',
    component: SuperButtonComponent,
    canActivate: [DynamicConfigGuard],
    data: {
      features: 'super_button'
    }
  }
];
```

