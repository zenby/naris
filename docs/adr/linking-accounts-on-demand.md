
# Связывание по запросу

**1. Логика механизма:**
**1.1. Для связывания через сервис аутентификации:**
- *(на клиенте)* Пользователь А имеет идентификатор (RefreshTocken).
- *(на клиенте)* Пользователь А передает серверу, что хочет связать свой аккаунт с Пользователем Б, который будет получен по oAuth от сервисов аутентификации.
- *(на сервере)* перенаправляет Пользователя А на выбранный сервис аутентификации.
- *(на сервисе oAuth)* Пользователь А проходит аутентифкацию на сервисе под Пользователем Б.
- *(на сервере)* получает подтверждение от oAuth сервиса и связывает полученный email по идентификатору Пользователя А, добавляя данный идентификатор в поле groupUUID таблицы пользователей.
**1.2. Для связывания по логину/паролю:**
- *(на клиенте)* Пользователь А имеет идентификатор (RefreshTocken).
- *(на клиенте)* Пользователь А передает серверу, что хочет связать свой аккаунт с Пользователем Б, который зарегистрирован в Приложении по логину/паролю.
- *(на сервере)* Пользователь А проходит аутентифкацию в Приложении под Пользователем Б.
- *(на сервере)* находит Пользователя Б в БД и связывает его по идентификатору Пользователя А, добавляя данный идентификатор в поле groupUUID таблицы пользователей.

**2. Ограничения, которые проверяет клиентская часть:**
- Не давать возможность отправлять запрос на привязку если есть какой-то тариф (при этом принять запрос можно, так как UUID подписки не теряется).
- Не давать возможность отправлять запрос на привязку если такой тип привязки уже используется (нельзя связывать два аккаунта по двум Яндекс-почтам или двум разным логинам и т.д.).

**3. Ограничения, которые проверяет серверная часть:**
- Не давать возможность связывать аккаунты, если добавляемый аккаунт уже связан с другим.

**4. Реализация серверной части:**
- Добавить groupUUID в таблицу пользователей.
- Реализовать методы добавления uuid текущего пользователя (из RefreshToken) в поле groupUUID таблицы пользователей по логину/email связываемого аккаунта.


### Flow-диаграмма связывания по запросу
```mermaid
flowchart TB
BEGIN[А: Добавление связанного аккаунта]
    CON{Произвести связывание\nчерез сервис\nаутентификации?}
    BEGIN--->CON
    CON--Да-->CLIENT_A[А: Выбор сервиса\nаутентификации\nдля связывания]
    CLIENT_A-->SERVER_1[Сервер: Перенаправление\nна выбранный сервис\nаутентификации]
    SERVER_1-->CLIENT_AUTH[А: Аутентификация под\nпользователем Б]
    CLIENT_AUTH-->DONE[Сервер: Связывание пользователей\nА и Б по uuid Пользователя А]
    CON--Нет-->SERVER_2[Сервер: Перенаправление на\nидентификацию по логину/паролю]
    SERVER_2-->CLIENT_AUTH
  ```


### Плюсы:
- Возможность привязать новый аккаунт по oAuth, даже если Пользователь ни разу не заходил с него в Приложение.
- Нет необходимости создавать новые таблицы в БД.
- Пользователю А нет необходимости перезаходить на страницу под пользователем Б.

### Минусы:
- Если на клиенте уже выполнен вход в сервисе аутентификации (по которому хотим связать аккаунты), но не по той почте, которую Пользователь хочет привязать, то может случиться так, что будет привязан не тот email. Поэтому придется дополнительно обрабатывать такие неявные ситуации.


